@startuml secuencia-CU13-asignacion-materias
autonumber

actor "Administrador" as Admin
participant "UI: Teacher\nSubject\nManager" as UI
participant "TeacherSubject\nManager\n(Livewire)" as Controller
database "DB: UserSubjects,\nUsers,\nSubjects,\nCareers" as DB

== Listar Docentes ==

Admin -> UI: 1. Acceder al módulo
UI -> Controller: 2. render()
Controller -> DB: 2.1. Buscar usuarios\ncon rol "Docente"
DB --> Controller: 2.2. Lista de docentes
Controller -> DB: 2.3. Cargar materias\ny carreras
DB --> Controller: 2.4. Materias y carreras
Controller --> UI: 2.5. Vista con docentes
UI --> Admin: 2.6. Mostrar lista de docentes

== Buscar Docente ==

Admin -> UI: 3. Escribir en búsqueda
UI -> Controller: 3.1. updatingSearch()
Controller -> DB: 3.1.1. Filtrar docentes
DB --> Controller: 3.1.2. Docentes filtrados
Controller --> UI: 3.1.3. Actualizar lista
UI --> Admin: 3.1.4. Mostrar resultados

== Editar Asignación de Materias ==

Admin -> UI: 4. Seleccionar docente
UI -> Controller: 4.1. edit(id)
Controller -> DB: 4.1.1. find(user_id)
DB --> Controller: 4.1.2. Datos del docente
Controller -> DB: 4.1.3. Obtener materias\nasignadas
DB --> Controller: 4.1.4. UserSubjects
Controller --> UI: 4.1.5. Modal con datos
UI --> Admin: 4.1.6. Formulario con\nmaterias actuales

Admin -> UI: 5. Modificar materias\ny carreras
Admin -> UI: 6. Clic en "Guardar"

UI -> Controller: 6.1. save()

alt Validación exitosa
    Controller -> Controller: 6.1.1. validate()
    Controller -> Controller: 6.1.2. Filtrar datos\nválidos y únicos
    
    Controller -> DB: 6.1.3. beginTransaction()
    
    note right of Controller
        Proceso de sincronización:
        1. Obtener asignaciones actuales
        2. Comparar con nuevas
        3. Eliminar las que ya no están
        4. Crear las nuevas
    end note
    
    Controller -> DB: 6.1.4. Obtener asignaciones\nexistentes
    DB --> Controller: 6.1.5. UserSubjects actuales
    
    Controller -> DB: 6.1.6. Eliminar asignaciones\nque ya no están
    DB --> Controller: 6.1.7. Confirmación
    
    Controller -> DB: 6.1.8. Crear nuevas\nasignaciones
    DB --> Controller: 6.1.9. Confirmación
    
    Controller -> DB: 6.1.10. commit()
    
    Controller --> UI: 6.1.11. Mensaje de éxito
    UI --> Admin: 6.1.12. "Materias asignadas\ncorrectamente"
    
else Error de validación
    Controller -> DB: 6.2. rollback()
    Controller --> UI: 6.3. Mensaje de error
    UI --> Admin: 6.4. Mostrar error específico
end

== Limpiar Búsqueda ==

Admin -> UI: 7. Clic en limpiar
UI -> Controller: 7.1. clearSearch()
Controller --> UI: 7.1.1. Resetear búsqueda
UI --> Admin: 7.1.2. Mostrar todos\nlos docentes

@enduml
