@startuml secuencia-CU16-reportes-dinamicos
autonumber

actor "Coordinador" as User
participant "UI: Dynamic\nReport" as UI
participant "Controller:\nDynamicReport\nController" as Controller
participant "Model:\nReportTemplate" as Template
participant "DB:\nTables" as Tables

== Acceder al Módulo ==

User -> UI: 1. Acceder al módulo
UI -> Controller: 1.1. index()
Controller --> UI: 1.1.1. Vista con tablas\ndisponibles
UI --> User: 1.1.2. Mostrar interfaz

== Seleccionar Tabla y Campos ==

User -> UI: 2. Seleccionar tabla
UI -> Controller: 2.1. getTableFields()
Controller -> Tables: 2.1.1. Schema::getColumnListing()
Tables --> Controller: 2.1.2. Lista de columnas
Controller --> UI: 2.1.3. Campos disponibles\ncon etiquetas
UI --> User: 2.1.4. Mostrar campos

User -> UI: 3. Seleccionar campos\ny aplicar filtros

== Generar Reporte ==

User -> UI: 4. Clic en "Generar"
UI -> Controller: 4.1. generate(request)

alt Validación exitosa
    Controller -> Controller: 4.1.1. validate()\n[tabla, campos]
    
    Controller -> Controller: 4.1.2. prepareReportQuery()
    
    note right of Controller
        Construye consulta SQL:
        - SELECT campos
        - FROM tabla
        - WHERE filtros
        - JOIN relaciones
    end note
    
    Controller -> Tables: 4.1.3. DB::table()->select()\n->where()->get()
    Tables --> Controller: 4.1.4. Resultados
    
    Controller --> UI: 4.1.5. Vista con resultados\npaginados
    UI --> User: 4.1.6. Mostrar reporte
    
else Error de validación
    Controller --> UI: 4.2. Mensaje de error
    UI --> User: 4.3. Mostrar error
end

== Exportar Reporte ==

User -> UI: 5. Seleccionar formato\n(PDF/Excel/HTML)

alt Exportar PDF
    UI -> Controller: 5.1. downloadPdf()
    Controller -> Controller: 5.1.1. prepareReportQuery()
    Controller -> Tables: 5.1.2. Ejecutar consulta
    Tables --> Controller: 5.1.3. Datos
    Controller -> Controller: 5.1.4. Generar PDF
    Controller --> User: 5.1.5. Descargar archivo PDF
    
else Exportar Excel
    UI -> Controller: 5.2. downloadExcel()
    Controller -> Controller: 5.2.1. prepareReportQuery()
    Controller -> Tables: 5.2.2. Ejecutar consulta
    Tables --> Controller: 5.2.3. Datos
    Controller -> Controller: 5.2.4. Generar Excel
    Controller --> User: 5.2.5. Descargar archivo XLSX
    
else Exportar HTML
    UI -> Controller: 5.3. downloadHtml()
    Controller -> Controller: 5.3.1. prepareReportQuery()
    Controller -> Tables: 5.3.2. Ejecutar consulta
    Tables --> Controller: 5.3.3. Datos
    Controller -> Controller: 5.3.4. Generar HTML
    Controller --> User: 5.3.5. Descargar archivo HTML
end

== Guardar como Plantilla ==

User -> UI: 6. Clic en "Guardar\nPlantilla"
UI -> Controller: 6.1. saveTemplate(request)

Controller -> Controller: 6.1.1. validate()
Controller -> Template: 6.1.2. create([\ntable, fields, filters,\nname, description,\nis_public, user_id])
Template --> Controller: 6.1.3. Confirmación

Controller --> UI: 6.1.4. Mensaje de éxito
UI --> User: 6.1.5. "Plantilla guardada"

== Cargar Plantilla ==

User -> UI: 7. Seleccionar plantilla\nguardada
UI -> Controller: 7.1. loadTemplate(id)

Controller -> Template: 7.1.1. find(id)
Template --> Controller: 7.1.2. Datos de plantilla
Controller --> UI: 7.1.3. Configuración\ncargada
UI --> User: 7.1.4. Formulario pre-llenado

@enduml
